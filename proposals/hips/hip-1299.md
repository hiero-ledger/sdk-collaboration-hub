# HIP-1299: Node Account ID Refinements for Dynamic Address Book

## Summary
This hip refines the rules for managing the account ID associated with
Node entries in the Dynamic Address Book (DAB). It enables rotations and removals of the account ID—meaning changing the account linked to a node.
The updated node account ID propagates to the mirror node, and clients/SDKs should pick up the change from the mirror node’s nodes API. Node account ID changes can occur at any time and there are no scheduling restrictions.

## Internal changes

### Handling `INVALID_NODE_ACCOUNT`
When a node’s account ID is changed via `NodeUpdateTransaction`, the new node account ID must be used immediately (i.e., for any subsequent transactions that target that node after the update reaches consensus).
Transactions that still reference the old node account ID will fail with `INVALID_NODE_ACCOUNT`.
When the SDKs encounter `INVALID_NODE_ACCOUNT` status code, the signed transaction intended for this node IP has outdated node account id embeded in it. This essencially means that in the lifecycle of this frozen SDK transaction signed transactions intended for this node will never succeed. In order to succeed the signed transaction needs to be rebuilt with the new node account id and resigned - which is not feasable at this point of the transaction lifecycle.

In order to improve the user experience of the SDKs, several changes need to be made in the retry mechanism:
- Add `INVALID_NODE_ACCOUNT` to the list of retryable status codes.
- Add special handling in the `RETRY` execution state for `INVALID_NODE_ACCOUNT`:
    - mark the node as unusable by increasing it's backoff and removing it from the healthy nodes list
    - initiate addressbook query and update the client's network, this will make the SDK client has the latest node account ids for any subsequent transactions

## Test Plan

1. **Given** a node with an existing account ID, **when** a NodeUpdateTransaction is submitted to change the account ID to a new valid account with signatures from both the node admin key and the account ID key, **then** the transaction succeeds.

2. **Given** a node with an existing account ID, **when** a NodeUpdateTransaction is submitted to change the account ID to the same existing account ID with proper signatures, **then** the transaction succeeds.

3. **Given** a node with an existing account ID, **when** a NodeUpdateTransaction is submitted to change the account ID to a new valid account with only the node admin key signature (missing account ID signature), **then** the transaction fails with `INVALID_SIGNATURE`.

4. **Given** a node with an existing account ID, **when** a NodeUpdateTransaction is submitted to change the account ID to a new valid account with only the account ID key signature (missing node admin signature), **then** the transaction fails with `INVALID_SIGNATURE`.

5. **Given** a node with an existing account ID, **when** a NodeUpdateTransaction is submitted to remove the account ID (set to 0.0.0) without node admin key signature, **then** the transaction fails with `INVALID_SIGNATURE`.

6. **Given** a node with an existing account ID, **when** a NodeUpdateTransaction is submitted to change the account ID to a non-existent account, **then** the transaction fails with `INVALID_SIGNATURE`.

7. **Given** a node with an existing account ID, **when** a NodeUpdateTransaction is submitted to change the account ID to a deleted account with proper signatures, **then** the transaction fails with `ACCOUNT_DELETED`.

8. **Given** a node update transaction, **when** it attempts to set account ID to the treasury account (0.0.2), **then** the transaction fails.

9. **Given** a node whose account ID has been updated, **when** a transaction is submitted to that node with the old account ID after the NodeUpdateTransaction reaches consensus, **then** the signed transaction for this node fails with `INVALID_NODE_ACCOUNT` and the SDK retries successfully with another node, updates its network with the latest node account IDs of the existing nodes in the network and subsequent transactions succeed.

10. **Given** a client without mirror network setup and a node whose account ID has been updated, **when** a transaction is submitted to that node with the old account ID after the NodeUpdateTransaction reaches consensus, **then** the signed transaction for this node fails with `INVALID_NODE_ACCOUNT` and the SDK retries successfully with another node and does not update it's address book.