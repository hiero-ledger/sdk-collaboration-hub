# HIP-1340: EOA Code Delegation

HIP: https://hips.hedera.com/hip/hip-1340

EIP: https://eips.ethereum.org/EIPS/eip-7702

This HIP introduces **EOA (Externally Owned Account) Code Delegation**, enabling EOAs to delegate their code execution to smart contracts. This feature aligns Hiero with Ethereum's Pectra upgrade (EIP-7702) and enables advanced account abstraction use cases. The implementation requires adding a `delegationAddress` field to account creation and update transactions, as well as exposing it in account information queries. Additionally, this proposal formalizes the structure for EIP-7702 Ethereum Transaction Type 4, which allows setting code delegation via Ethereum-compatible transactions.

All changes are strictly additive and maintain backwards compatibility. The delegation address must be exactly 20 bytes and can be provided as raw bytes, hex string (with or without 0x prefix), or a language-specific `EvmAddress` type. Setting the address to 20 zero-bytes or `null` (for update transactions) clears any existing delegation.

## New APIs

### Authorization

```
Authorization {
    @@immutable chainId: bytes
    @@immutable address: bytes
    @@immutable nonce: uint64
    @@immutable yParity: uint32
    @@immutable r: bytes
    @@immutable s: bytes
}
```

### EthereumTransactionDataEip7702

```
EthereumTransactionDataEip7702 {
    @@immutable chainId: bytes
    @@immutable nonce: bytes
    @@immutable maxPriorityGas: bytes
    @@immutable maxGas: bytes
    @@immutable gasLimit: bytes
    @@immutable to: bytes
    @@immutable value: bytes
    @@immutable callData: bytes
    @@immutable accessList: list<bytes>
    @@immutable authorizationList: list<Authorization>
    @@immutable recId: bytes
    @@immutable r: bytes
    @@immutable s: bytes
}
```

## Updated APIs

### AccountCreateTransaction

```
AccountCreateTransaction {
    @@nullable delegationAddress: EvmAddress

    @@throws(invalid-address-error)
    AccountCreateTransaction setDelegationAddress(address: bytes | string | EvmAddress)

    @@nullable EvmAddress getDelegationAddress()
}
```

### AccountUpdateTransaction

```
AccountUpdateTransaction {
    @@nullable delegationAddress: EvmAddress

    @@throws(invalid-address-error)
    AccountUpdateTransaction setDelegationAddress(address: bytes | string | EvmAddress | null)

    @@nullable EvmAddress getDelegationAddress()
}
```

### AccountInfo

```
AccountInfo {
    // ... existing fields ...

    @@nullable @@immutable delegationAddress: EvmAddress
}
```

**Note:** Getter and setter methods should follow language-specific best practices and naming conventions. For example:

- JavaScript/TypeScript: Property access `tx.delegationAddress` and method `setDelegationAddress()`
- Rust: `set_delegation_address()` and `delegation_address()` (snake_case)
- Go: `GetDelegationAddress()` and `SetDelegationAddress()` (camelCase with get/set prefix)
- Java: `getDelegationAddress()` and `setDelegationAddress()` (camelCase with get/set prefix)

## Test Plan

1. **Given** an AccountCreateTransaction is configured with a delegation address as a string, **when** the transaction is executed, **then** the account is created successfully with the delegation address set.

2. **Given** an AccountCreateTransaction is configured with a delegation address as bytes, **when** the transaction is executed, **then** the account is created successfully with the delegation address set.

3. **Given** an AccountCreateTransaction is configured with a delegation address as an EvmAddress type, **when** the transaction is executed, **then** the account is created successfully with the delegation address set.

4. **Given** an AccountUpdateTransaction is configured with a delegation address, **when** the transaction is executed, **then** the account is updated successfully with the delegation address set.

5. **Given** an AccountUpdateTransaction is configured with 20 zero-bytes as the delegation address, **when** the transaction is executed, **then** any existing delegation is cleared.

6. **Given** an AccountUpdateTransaction is configured with `null` as the delegation address (if supported), **when** the transaction is executed, **then** any existing delegation is cleared.

7. **Given** an account with a delegation address is queried using AccountInfoQuery, **when** the query is executed, **then** the AccountInfo response includes the delegation address.

8. **Given** an account without a delegation address is queried using AccountInfoQuery, **when** the query is executed, **then** the AccountInfo response has a null delegation address.

9. **Given** there are Ethereum transaction bytes containing EIP-7702 authorization data, **when** the bytes are parsed using `fromBytes()` and then set using `setEthereumTransaction()` on an EthereumTransaction, **then** the transaction executes successfully and the code delegation is set according to the authorization entries.

10. **Given** there are Ethereum transaction bytes containing EIP-7702 authorization data, **when** the bytes are set directly using `setEthereumTransaction()` on an EthereumTransaction, **then** the transaction executes successfully and the code delegation is set according to the authorization entries.

## Examples

### Creating an Account with Code Delegation

```javascript
import { AccountCreateTransaction } from "@hiero/sdk";

const transaction = new AccountCreateTransaction()
  .setKey(publicKey)
  .setDelegationAddress("0x1111111111111111111111111111111111111111")
  .freezeWith(client);

// Access delegation address via property
const delegationAddr = transaction.delegationAddress;
console.log(`Delegation address: ${delegationAddr?.toString()}`);

const response = await transaction.execute(client);
const accountId = (await response.getReceipt(client)).accountId;
```

### Updating an Account to Set Code Delegation

```javascript
import { AccountUpdateTransaction } from "@hiero/sdk";

const transaction = new AccountUpdateTransaction()
  .setAccountId(accountId)
  .setDelegationAddress("0x2222222222222222222222222222222222222222")
  .freezeWith(client);

// Access delegation address via property
console.log(`Delegation address: ${transaction.delegationAddress?.toString()}`);

const response = await transaction.execute(client);
const receipt = await response.getReceipt(client);
```

### Clearing Code Delegation

```javascript
import { AccountUpdateTransaction } from "@hiero/sdk";

// Option 1: Zero address
const transaction = new AccountUpdateTransaction()
  .setAccountId(accountId)
  .setDelegationAddress("0x0000000000000000000000000000000000000000")
  .freezeWith(client);

// Access delegation address via property (will be zero address)
console.log(`Delegation address: ${transaction.delegationAddress?.toString()}`);

const response = await transaction.execute(client);
const receipt = await response.getReceipt(client);
```

### Querying Account Info with Delegation Address

```javascript
import { AccountInfoQuery } from "@hiero/sdk";

const info = await new AccountInfoQuery()
  .setAccountId(accountId)
  .execute(client);

// Access delegation address from AccountInfo
if (info.delegationAddress != null) {
  console.log(`Account delegates to: ${info.delegationAddress.toString()}`);
} else {
  console.log("Account has no delegation address");
}
```

### Setting Code Delegation via EIP-7702 Ethereum Transaction

```javascript
import { EthereumTransaction } from "@hiero/sdk";

const transaction = new EthereumTransaction()
  .setEthereumTransaction(ethereumTransactionBytes)
  .freezeWith(client);

const response = await transaction.execute(client);
const receipt = await response.getReceipt(client);
```
