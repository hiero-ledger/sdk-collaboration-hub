# HIP-1195: Hiero hooks and an application to allowances

HIP: https://hips.hedera.com/hip/hip-1195

This HIP introduces **hooks**, programmable Hiero extension points that let users customize the behavior of their entities. The initial implementation focuses on **EVM hooks** and **account allowance hooks** as the first extension point.

## New APIs

#### HookExtensionPoint
```
enum HookExtensionPoint {
    ACCOUNT_ALLOWANCE_HOOK = 0
}
```

#### HookCreationDetails
```
type HookCreationDetails {
    HookExtensionPoint extensionPoint
    uint64 hookId
    // oneof (mutually exclusive):
    PureEvmHook evmHook
    LambdaEvmHook lambdaHook 
    Key adminKey
}
```

#### PureEvmHook and LambdaEvmHook
```
type PureEvmHook extends EvmHookSpec {}

type LambdaEvmHook extends EvmHookSpec {
    List<LambdaStorageUpdate> storageUpdates
}

type EvmHookSpec {
    ContractId contractId
}
```

#### LambdaStorageUpdate
```
type LambdaStorageUpdate {
    // oneof (mutually exclusive):
    LambdaStorageSlot storageSlot  
    LambdaMappingEntry mappingEntry 
}

type LambdaStorageSlot {
    bytes key     // 32-byte storage slot key
    bytes value   // 32-byte storage slot value (empty to delete)
}

type LambdaMappingEntry {
    bytes mappingSlot  // Slot corresponding to Solidity mapping
    bytes key          // 32-byte key of mapping entry
    bytes value        // 32-byte value of mapping entry (empty to delete)
}
```

#### HookCall and EvmHookCall
```
type HookCall {
    uint64 hookId
    EvmHookCall evmHookCall 
}

type EvmHookCall {
    bytes data
    uint64 gasLimit
}
```

#### LambdaSStoreTransaction
```
type LambdaSStoreTransaction {
    CreatedHookId hookId
    List<LambdaStorageUpdate> storageUpdates 
}
```

## Updated APIs

#### AccountCreateTransaction
- `addHook(HookCreationDetails)` - Add a hook to be created with the account
- `setHooks(List<HookCreationDetails>)` - Set hooks to be created with the account
- `List<HookCreationDetails> getHooks()` - Get the list of hooks to be created

#### AccountUpdateTransaction  
- `addHook(HookCreationDetails)` - Add a hook to be created for the account
- `setHooks(List<HookCreationDetails>)` - Set hooks to be created with the account
- `deleteHook(uint64)` - Mark a hook for deletion from the account
- `deleteHooks(List<uint64>)` - Mark hooks for deletion from the account
- `List<HookCreationDetails> getHooksToCreate()` - Get the list of hooks to be created
- `List<uint64> getHooksToDelete()` - Get the list of hook IDs to be deleted

#### ContractCreateTransaction
- `addHook(HookCreationDetails)` - Add a hook to be created with the contract
- `setHooks(List<HookCreationDetails>)` - Set hooks to be created with the contract 
- `List<HookCreationDetails> getHooks()` - Get the list of hooks to be created

#### ContractUpdateTransaction
- `addHook(HookCreationDetails)` - Add a hook to be created for the contract
- `setHooks(List<HookCreationDetails>)` - Set hooks to be created with the contract
- `deleteHook(uint64)` - Mark a hook for deletion from the contract
- `deleteHooks(List<uint64>)` - Mark hooks for deletion from the contract
- `List<HookCreationDetails> getHooksToCreate()` - Get the list of hooks to be created
- `List<uint64> getHooksToDelete()` - Get the list of hook IDs to be deleted

#### TransferTransaction (CryptoTransfer)

#### AccountAmount
- `setPreTxAllowanceHook(AccountId, HookCall)` - Set pre-transaction allowance hook for HBAR transfer
- `setPrePostTxAllowanceHook(AccountId, HookCall)` - Set pre/post-transaction allowance hook for HBAR transfer

#### TokenNftTransfer
- `setPreTxSenderAllowanceHook(TokenId, int64, HookCall)` - Set sender allowance hook for NFT transfer
- `setPrePostTxSenderAllowanceHook(TokenId, int64, HookCall)` - Set sender allowance hook for NFT transfer
- `setPreTxReceiverAllowanceHook(TokenId, int64, HookCall)` - Set receiver allowance hook for NFT transfer
- `setPrePostTxReceiverAllowanceHook(TokenId, int64, HookCall)` - Set receiver allowance hook for NFT transfer

#### AccountInfoQuery
Extended response to include hook information:

**Additional AccountInfo fields:**
- `numberHooksInUse` - The number of hooks currently in use on the account
- `firstHookId` - The ID of the first hook in the account's hook list (if any)
- `numberLambdaStorageSlots` - The total number of storage slots used by the account's lambda hooks

## Test Plan

### AccountCreateTransaction

1. **Given** an AccountCreateTransaction is configured with a pure EVM hook, **when** the transaction is executed, **then** the account is created successfully and the hook is attached with a unique hook ID.

2. **Given** an AccountCreateTransaction is configured with a lambda EVM hook and initial storage updates, **when** the transaction is executed, **then** the account is created with the lambda hook and storage is initialized correctly.

### AccountUpdateTransaction

3. **Given** an account exists without hooks, **when** an AccountUpdateTransaction adds a pure EVM hook with valid signatures, **then** the hook is successfully attached to the account.

4. **Given** an account exists without hooks, **when** an AccountUpdateTransaction adds a lambda EVM hook with initial storage, **then** the lambda hook is attached and storage slots are created.

5. **Given** an account exists with multiple hooks, **when** an AccountUpdateTransaction attempts to add a hook with a duplicate hook ID, **then** the transaction fails with an invalid hook ID error.

6. **Given** an account exists with hooks, **when** an AccountUpdateTransaction deletes specific hooks by ID with valid signatures, **then** the specified hooks are removed from the account.

### ContractCreateTransaction

7. **Given** a ContractCreateTransaction is configured with a pure EVM hook, **when** the transaction is executed, **then** the contract is created successfully with the hook attached.

8. **Given** a ContractCreateTransaction is configured with a lambda EVM hook and initial storage, **when** the transaction is executed, **then** the contract is created with the lambda hook and storage initialized.

### ContractUpdateTransaction

9. **Given** a contract exists without hooks, **when** a ContractUpdateTransaction adds hooks with valid signatures, **then** the hooks are successfully attached to the contract.

10. **Given** a contract exists with hooks, **when** a ContractUpdateTransaction deletes hooks by ID with valid signatures, **then** the specified hooks are removed from the contract.

### AccountInfoQuery

11. **Given** an account has lambda hooks with storage, **when** an AccountInfoQuery is executed, **then** the response includes the correct number of hooks, first hook ID, and lambda storage slot count.

### ContractInfoQuery

12. **Given** a contract has lambda hooks with storage, **when** a ContractInfoQuery is executed, **then** the response includes the correct number of hooks, first hook ID, and lambda storage slot count.

### LambdaSStoreTransaction

13. **Given** a lambda hook exists with storage, **when** a LambdaSStoreTransaction updates storage slots with valid signatures, **then** the storage is updated successfully.

14. **Given** a lambda hook exists, **when** a LambdaSStoreTransaction attempts to update storage without proper signatures, **then** the transaction fails with an unauthorized error.

### TransferTransaction

15. **Given** an account has a pre-transaction allowance hook configured, **when** a TransferTransaction attempts to transfer HBAR from that account, **then** the hook is called before the transfer and approves the transaction.

16. **Given** an account has a pre-transaction allowance hook that validates transfer limits, **when** a TransferTransaction exceeds the allowed amount, **then** the hook rejects the transfer and the transaction fails.

17. **Given** an account has a pre/post-transaction allowance hook configured, **when** a successful HBAR transfer occurs, **then** the hook is called both before and after the transfer execution.

18. **Given** an account has an allowance hook for token transfers, **when** a TransferTransaction includes token transfers from that account, **then** the hook validates the token allowance and approves valid transfers.

19. **Given** an account has an NFT allowance hook configured, **when** a TransferTransaction attempts to transfer an NFT from that account, **then** the hook validates the NFT allowance and processes the transfer accordingly.

20. **Given** multiple accounts in a transfer have different allowance hooks, **when** a TransferTransaction involves all accounts, **then** each account's respective hooks are called and must all approve for the transaction to succeed.

21. **Given** an account has an allowance hook that tracks daily transfer limits, **when** multiple TransferTransactions are executed within the same day, **then** the hook maintains state and enforces cumulative limits correctly.

22. **Given** a sender account has an allowance hook and receiver account has a different allowance hook, **when** a TransferTransaction occurs between them, **then** both sender and receiver hooks are executed in the correct order.

## Examples

### Creating an Account with a Pure EVM Hook

```javascript
import {
  Client,
  AccountCreateTransaction,
  HookCreationDetails,
  PureEvmHook,
  HookExtensionPoint,
  ContractId,
  PrivateKey
} from "@hashgraph/sdk";

// Step 1: Create hook details for a pure EVM hook
const hookDetails = new HookCreationDetails()
  .setExtensionPoint(HookExtensionPoint.ACCOUNT_ALLOWANCE_HOOK)
  .setHookId(1001)
  .setEvmHook(new PureEvmHook()
    .setContractId(ContractId.fromString("0.0.12345")))
  .setAdminKey(adminKey.publicKey);

// Step 2: Create account with the hook
const accountCreateTx = new AccountCreateTransaction()
  .setKey(accountKey.publicKey)
  .addHook(hookDetails)
  .freezeWith(client)
  .sign(accountKey);

const response = await accountCreateTx.execute(client);
const accountId = (await response.getReceipt(client)).accountId;
```

### Creating an Account with a Lambda EVM Hook

```javascript
import {
  LambdaEvmHook,
  LambdaStorageUpdate,
  LambdaStorageSlot
} from "@hashgraph/sdk";

// Step 1: Create initial storage updates
const storageUpdates = [
  new LambdaStorageUpdate().setStorageSlot(
    new LambdaStorageSlot()
      .setKey(new Uint8Array(32).fill(1)) 
      .setValue(new Uint8Array(32).fill(100))
  )
];

// Step 2: Create lambda hook with storage
const lambdaHookDetails = new HookCreationDetails()
  .setExtensionPoint(HookExtensionPoint.ACCOUNT_ALLOWANCE_HOOK)
  .setHookId(1002)
  .setLambdaHook(new LambdaEvmHook()
    .setContractId(ContractId.fromString("0.0.67890"))
    .setStorageUpdates(storageUpdates))
  .setAdminKey(adminKey.publicKey);

// Step 3: Create account with lambda hook
const accountCreateTx = new AccountCreateTransaction()
  .setKey(accountKey.publicKey)
  .addHook(lambdaHookDetails)
  .freezeWith(client)
  .sign(accountKey);

const response = await accountCreateTx.execute(client);
const accountId = (await response.getReceipt(client)).accountId;
```

### Adding Hooks to an Existing Account

```javascript
import { AccountUpdateTransaction } from "@hashgraph/sdk";

const accountUpdateTx = new AccountUpdateTransaction()
  .setAccountId(existingAccountId)
  .addHook(hookDetails1)
  .addHook(hookDetails2)
  .freezeWith(client)
  .sign(accountKey)
  .sign(adminKey);

await accountUpdateTx.execute(client);
```

### Updating Lambda Hook Storage

```javascript
import { LambdaSStoreTransaction } from "@hashgraph/sdk";

const storageUpdate = new LambdaStorageUpdate()
  .setStorageSlot(new LambdaStorageSlot()
    .setKey(new Uint8Array(32).fill(1))
    .setValue(new Uint8Array(32).fill(200)));

const lambdaStoreTx = new LambdaSStoreTransaction()
  .setHookId(1002)
  .addStorageUpdate(storageUpdate)
  .freezeWith(client)
  .sign(adminKey);

await lambdaStoreTx.execute(client);
```

### Querying Account Hook Information

```javascript
import { AccountInfoQuery } from "@hashgraph/sdk";

const accountInfo = await new AccountInfoQuery()
  .setAccountId(accountId)
  .execute(client);

console.log("Number of hooks:", accountInfo.numberHooksInUse);
console.log("First hook ID:", accountInfo.firstHookId);
console.log("Lambda storage slots:", accountInfo.numberLambdaStorageSlots);
```