# HIP-1195: Hiero hooks and an application to allowances

HIP: https://hips.hedera.com/hip/hip-1195

This HIP introduces **hooks**, programmable Hiero extension points that let users customize the behavior of their entities. The initial implementation focuses on **EVM hooks** and **account allowance hooks** as the first extension point.

## New APIs

#### HookExtensionPoint
```
enum HookExtensionPoint {
    ACCOUNT_ALLOWANCE_HOOK = 0
}
```

#### HookCreationDetails
```
type HookCreationDetails {
    HookExtensionPoint extensionPoint
    uint64 hookId
    // oneof (mutually exclusive):
    PureEvmHook evmHook
    LambdaEvmHook lambdaHook 
    Key adminKey
}
```

#### PureEvmHook and LambdaEvmHook
```
type PureEvmHook extends EvmHookSpec {}

type LambdaEvmHook extends EvmHookSpec {
    List<LambdaStorageUpdate> storageUpdates
}

type EvmHookSpec {
    ContractId contractId
}
```

#### LambdaStorageUpdate
```
type LambdaStorageUpdate {
    // oneof (mutually exclusive):
    LambdaStorageSlot storageSlot  
    LambdaMappingEntry mappingEntry 
}

type LambdaStorageSlot {
    bytes key     // 32-byte storage slot key
    bytes value   // 32-byte storage slot value (empty to delete)
}

type LambdaMappingEntry {
    bytes mappingSlot  // Slot corresponding to Solidity mapping
    bytes key          // 32-byte key of mapping entry
    bytes value        // 32-byte value of mapping entry (empty to delete)
}
```

#### HookCall and EvmHookCall
```
type HookCall {
    uint64 hookId
    EvmHookCall evmHookCall 
}

type EvmHookCall {
    bytes data
    uint64 gasLimit
}
```

## Updated APIs

#### AccountCreateTransaction
- `addHook(HookCreationDetails)` - Add a hook to be created with the account
- `setHooks(List<HookCreationDetails>)` - Set hooks to be created with the account
- `List<HookCreationDetails> getHooks()` - Get the list of hooks to be created

#### AccountUpdateTransaction  
- `addHook(HookCreationDetails)` - Add a hook to be created for the account
- `setHooks(List<HookCreationDetails>)` - Set hooks to be created with the account
- `deleteHook(uint64)` - Mark a hook for deletion from the account
- `deleteHooks(List<uint64>)` - Mark hooks for deletion from the account
- `List<HookCreationDetails> getHooksToCreate()` - Get the list of hooks to be created
- `List<uint64> getHooksToDelete()` - Get the list of hook IDs to be deleted

#### ContractCreateTransaction
- `addHook(HookCreationDetails)` - Add a hook to be created with the contract
- `setHooks(List<HookCreationDetails>)` - Set hooks to be created with the contract 
- `List<HookCreationDetails> getHooks()` - Get the list of hooks to be created

#### ContractUpdateTransaction
- `addHook(HookCreationDetails)` - Add a hook to be created for the contract
- `setHooks(List<HookCreationDetails>)` - Set hooks to be created with the contract
- `deleteHook(uint64)` - Mark a hook for deletion from the contract
- `deleteHooks(List<uint64>)` - Mark hooks for deletion from the contract
- `List<HookCreationDetails> getHooksToCreate()` - Get the list of hooks to be created
- `List<uint64> getHooksToDelete()` - Get the list of hook IDs to be deleted

#### TransferTransaction (CryptoTransfer)

#### AccountAmount
- `setPreTxAllowanceHook(AccountId, HookCall)` - Set pre-transaction allowance hook for HBAR transfer
- `setPrePostTxAllowanceHook(AccountId, HookCall)` - Set pre/post-transaction allowance hook for HBAR transfer

#### TokenNftTransfer
- `setPreTxSenderAllowanceHook(TokenId, int64, HookCall)` - Set sender allowance hook for NFT transfer
- `setPrePostTxSenderAllowanceHook(TokenId, int64, HookCall)` - Set sender allowance hook for NFT transfer
- `setPreTxReceiverAllowanceHook(TokenId, int64, HookCall)` - Set receiver allowance hook for NFT transfer
- `setPrePostTxReceiverAllowanceHook(TokenId, int64, HookCall)` - Set receiver allowance hook for NFT transfer

#### AccountInfoQuery
Extended response to include hook information:

**Additional AccountInfo fields:**
- `numberHooksInUse` - The number of hooks currently in use on the account
- `firstHookId` - The ID of the first hook in the account's hook list (if any)
- `numberLambdaStorageSlots` - The total number of storage slots used by the account's lambda hooks

## Test Plan

### Basic Hook Management Tests

1. **Hook Creation via AccountCreateTransaction**
   - Create account with pure EVM hook
   - Create account with lambda EVM hook with initial storage
   - Validate hook presence in AccountInfoQuery
   - Verify hook creation fails with invalid contract ID
   - Test hook creation with admin key

2. **Hook Creation via AccountUpdateTransaction**
   - Add hooks to existing account
   - Verify hook ID uniqueness validation
   - Test creating hook with existing ID (should fail with INDEX_IN_USE)
   - Test atomic delete and recreate with same hook ID

3. **Hook Deletion via AccountUpdateTransaction**
   - Delete existing hooks
   - Test deleting non-existent hook (should fail with HOOK_NOT_FOUND)
   - Verify hook deletion updates account info

4. **Lambda Storage Management**
   - Create lambda hook with initial storage
   - Update storage using LambdaStorageStoreTransaction
   - Test storage updates with mapping entries
   - Verify admin key authorization for storage updates
   - Test storage updates signed by entity key

### Account Allowance Hook Tests

5. **HBAR Transfer with Allowance Hook**
   - Create account with allowance hook
   - Execute CryptoTransfer with pre-transaction hook call
   - Execute CryptoTransfer with pre/post-transaction hook call
   - Verify hook execution with gas limit
   - Test hook failure scenarios (returns false, reverts)

6. **Token Transfer with Allowance Hook**
   - Test fungible token transfers with sender allowance hook
   - Test NFT transfers with sender allowance hook
   - Test NFT transfers with receiver allowance hook
   - Test transfers with both sender and receiver hooks
   - Verify custom fee handling with hooks

7. **Hook Gas and Fee Handling**
   - Test gas limit enforcement
   - Verify gas cost charging to transaction payer
   - Test hook refund mechanisms
   - Validate fee calculation includes hook execution

### Error Handling Tests

8. **Hook Reference Validation**
   - Test HOOK_NOT_FOUND for non-existent hook ID
   - Test BAD_HOOK_REQUEST for mismatched hook type
   - Verify proper error messages for invalid hook calls

9. **Gas Exhaustion Scenarios**
   - Test CONSENSUS_GAS_EXHAUSTED with insufficient gas limit
   - Verify throttling behavior for hook execution
   - Test gas limit validation

10. **Permission and Key Tests**
    - Test hook admin key permissions
    - Verify entity key permissions for storage updates
    - Test unauthorized hook operations

### Integration Tests

11. **Complex Transfer Scenarios**
    - Multi-asset transfers with multiple hooks
    - Transfers with custom fees and allowance hooks
    - Nested contract calls from hook execution

12. **Hook State Management**
    - Test hook state persistence across network restarts
    - Verify hook storage slot counting for rent calculation
    - Test hook archival with account deletion

## Examples